<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>☄☄☄ Smart Manager By Tech Brian ☄☄☄</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a73e8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Smart Manager">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    /* === CSS Variables (Unchanged) === */
    :root {
      --bg: #f4f7fb;
      --panel-bg: #ffffff;
      --text: #2c3e50;
      --accent: #1a73e8;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --border: #e0e6ed;
      --shadow: rgba(0,0,0,0.08);
      --radius: 12px;
      --transition: all 0.3s ease;
      --font-base: clamp(0.9rem, 2.5vw, 1rem);
    }
    [data-theme="dark"] {
      --bg: #121212;
      --panel-bg: #1e1e1e;
      --text: #e0e0e0;
      --accent: #4285f4;
      --success: #2ecc71;
      --warning: #f1c40f;
      --danger: #e74c3c;
      --border: #333;
      --shadow: rgba(0,0,0,0.3);
    }

    /* === Reset & Base (No Horizontal Scroll) === */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      font-size: 100%;
      scroll-behavior: smooth;
      overflow-x: hidden;
      width: 100%;
    }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      font-size: var(--font-base);
      transition: var(--transition);
      min-height: 100vh;
      padding-bottom: 4rem;
      max-width: 100vw;
    }

    /* === Splash Screen (Unchanged) === */
    #splash {
      position: fixed;
      inset: 0;
      background: var(--accent);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeOut 0.6s forwards 2.5s;
      cursor: pointer;
      text-align: center;
      padding: 1rem;
      overflow: hidden;
    }
    #splash img {
      width: clamp(80px, 25vw, 120px);
      height: auto;
      margin-bottom: 1rem;
      border-radius: 50%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    #splash h1 {
      font-size: clamp(1.8rem, 6vw, 2.5rem);
      margin: 1rem 0;
      animation: bounce 1.4s infinite;
    }
    #splash p {
      font-size: 1rem;
      opacity: 0.9;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes fadeOut {
      to { opacity: 0; visibility: hidden; }
    }

    /* === Header (Added Push Button) === */
    header {
      background: var(--panel-bg);
      padding: 0.8rem 1rem;
      box-shadow: 0 2px 8px var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      max-width: 100%;
    }
    header h1 {
      font-size: clamp(1.1rem, 4vw, 1.4rem);
      color: var(--accent);
      font-weight: 600;
    }
    #current-time {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    .theme-toggle, #push-toggle {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 0.5rem;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
    }
    #push-toggle.enabled { color: var(--success); }

    /* === Install Banner === */
    #install-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--panel-bg);
      color: var(--text);
      padding: 1rem;
      box-shadow: 0 -2px 10px var(--shadow);
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 1001;
      border-top: 2px solid var(--accent);
    }
    @media (min-width: 480px) {
      #install-banner { flex-direction: row; justify-content: space-between; align-items: center; }
    }
    #install-banner.show { display: flex; }
    #install-banner p { margin: 0; font-size: 0.95rem; }
    .install-actions { display: flex; gap: 0.5rem; }
    .install-btn, .install-close {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      min-height: 44px;
    }
    .install-btn { background: var(--accent); color: white; }
    .install-close { background: var(--border); color: var(--text); }

    /* === Panels, Tasks, etc. (Unchanged for brevity) === */
    .container {
      max-width: 1200px;
      margin: 1.5rem auto;
      padding: 0 1rem;
      display: grid;
      gap: 1.2rem;
      grid-template-columns: 1fr;
      width: 100%;
    }
    @media (min-width: 768px) {
      .container { grid-template-columns: 1fr 320px; }
    }
    .panel {
      background: var(--panel-bg);
      border-radius: var(--radius);
      padding: clamp(1rem, 3vw, 1.5rem);
      box-shadow: 0 4px 15px var(--shadow);
      border: 1px solid var(--border);
      width: 100%;
      max-width: 100%;
    }
    .panel h2 {
      margin-bottom: 1rem;
      color: var(--accent);
      font-size: clamp(1.1rem, 3.5vw, 1.3rem);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
    }
    #task-input {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
      margin-bottom: 1rem;
      width: 100%;
    }
    #task-input input, #task-input select, #task-input button {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      width: 100%;
      max-width: 100%;
    }
    #task-input input, #task-input select { min-height: 48px; }
    #task-input button {
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      min-width: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      grid-column: -1;
    }
    @media (min-width: 480px) {
      #task-input { grid-template-columns: 1fr auto 1fr auto; align-items: center; }
      #task-input button { grid-column: auto; }
    }
    #task-list {
      list-style: none;
      max-height: 60vh;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding-right: 4px;
      width: 100%;
    }
    .task-item {
      background: var(--bg);
      padding: 0.9rem;
      border-radius: 10px;
      margin-bottom: 0.75rem;
      border-left: 4px solid var(--accent);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      transition: var(--transition);
      width: 100%;
      max-width: 100%;
    }
    @media (min-width: 480px) {
      .task-item { flex-direction: row; justify-content: space-between; align-items: center; }
    }
    .task-item.completed { opacity: 0.7; border-left-color: var(--success); text-decoration: line-through; }
    .task-item.overdue { border-left-color: var(--danger); animation: pulse 1.8s infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
      70% { box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
      100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
    }
    .task-info { flex: 1; min-width: 0; }
    .task-info strong { font-size: 1rem; display: block; word-break: break-word; }
    .task-info small { font-size: 0.8rem; opacity: 0.8; }
    .task-countdown { font-size: 0.8rem; font-weight: 600; color: var(--warning); }
    .task-actions { display: flex; gap: 0.5rem; width: auto; }
    .task-actions button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.5rem;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: var(--transition);
    }
    .task-actions button:hover { background: rgba(0,0,0,0.05); }
    .category-badge {
      background: var(--accent);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      align-self: flex-start;
      display: inline-block;
    }
    #history-list {
      list-style: none;
      max-height: 250px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      font-size: 0.85rem;
      width: 100%;
    }
    .history-item {
      padding: 0.6rem 0;
      border-bottom: 1px dashed var(--border);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    @media (min-width: 480px) {
      .history-item { flex-direction: row; justify-content: space-between; }
    }
    .history-item span { word-break: break-word; }
    .contact-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 0.8rem;
      margin-top: 1rem;
      width: 100%;
    }
    .contact-item {
      text-align: center;
      padding: 1rem;
      background: var(--bg);
      border-radius: 10px;
      transition: var(--transition);
      min-height: 90px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: inherit;
      width: 100%;
    }
    .contact-item:hover { transform: translateY(-4px); box-shadow: 0 6px 16px var(--shadow); }
    .contact-item i { font-size: 1.6rem; color: var(--accent); margin-bottom: 0.4rem; }
    .contact-item span { font-size: 0.85rem; font-weight: 500; }
    #notifications {
      position: fixed;
      top: 0.5rem;
      right: 0.5rem;
      left: 0.5rem;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
      width: auto;
      max-width: 100%;
    }
    .toast {
      background: var(--panel-bg);
      color: var(--text);
      padding: 0.8rem 1rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--shadow);
      border-left: 4px solid var(--accent);
      animation: slideIn 0.4s ease, fadeOutToast 0.6s 4s forwards;
      min-width: 260px;
      max-width: 100%;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: all;
      font-size: 0.9rem;
    }
    @media (min-width: 480px) {
      #notifications { left: auto; }
      .toast { max-width: 320px; }
    }
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast .close {
      cursor: pointer;
      font-weight: bold;
      margin-left: 1rem;
      font-size: 1.2rem;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeOutToast {
      to { opacity: 0; transform: translateY(-20px); }
    }
    footer {
      text-align: center;
      padding: 1rem;
      margin-top: 2rem;
      color: #666;
      font-size: 1.3rem;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      max-width: 100%;
    }
    footer .theme-toggle {
      font-size: 0.95rem;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: white;
      border-radius: 8px;
      min-height: 44px;
    }
    #export-csv {
      margin-top: 1rem;
      width: 100%;
      padding: 0.8rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    #test-push { margin-top: 1rem; width: 100%; }
  </style>
</head>
<body>

  <!-- Splash Screen -->
  <div id="splash" onclick="this.style.display='none'">
    <img src="https://files.catbox.moe/qa99vf.jpg" alt="Smart Manager Icon" />
    <h1>Smart Manager</h1>
    <p>Smart Schedule Dashboard</p>
  </div>

  <!-- Header -->
  <header>
    <h1>Smart Manager</h1>
    <div style="display:flex; align-items:center; gap:0.5rem;">
      <span id="current-time"></span>
      <button class="theme-toggle" id="theme-toggle" aria-label="Toggle Theme">
        <i class="fas fa-moon"></i>
      </button>
      <button class="theme-toggle" id="push-toggle" aria-label="Toggle Push">
        <i class="fas fa-bell"></i>
      </button>
    </div>
  </header>

  <!-- Install Banner -->
  <div id="install-banner">
    <p><i class="fas fa-download"></i> Install Smart Manager for quick access—like a real app!</p>
    <div class="install-actions">
      <button class="install-btn" id="install-btn">Install</button>
      <button class="install-close" id="install-close">No Thanks</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">

    <!-- Task Management -->
    <section class="panel">
      <h2><i class="fas fa-tasks"></i> Task Management</h2>
      <div id="task-input">
        <input type="text" id="task-name" placeholder="Task name..." />
        <select id="task-category">
          <option value="Academic">Academic</option>
          <option value="Events">Events</option>
          <option value="Admin">Admin</option>
          <option valur="Fun">Fun</option>
        </select>
        <input type="datetime-local" id="task-due" placeholder="Due..."/>
        <button id="add-task"><i class="fas fa-plus"></i></button>
      </div>
      <ul id="task-list"></ul>
      <button id="test-push" style="display:none;">Test Push Notification</button>
    </section>

    <!-- Sidebar -->
    <aside>
      <!-- History -->
      <div class="panel">
        <h2><i class="fas fa-history"></i> Task History</h2>
        <ul id="history-list"></ul>
        <button id="export-csv">
          <i class="fas fa-download"></i> Export CSV
        </button>
      </div>

      <!-- Contact -->
      <div class="panel">
        <h2><i class="fas fa-address-book"></i> Contact Me</h2>
        <div class="contact-grid">
          <a href="https://wa.me/254748950572" target="_blank" class="contact-item">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
          </a>
          <a href="mailto:bridah888@gmail.com" class="contact-item">
            <i class="fas fa-envelope"></i>
            <span>Email</span>
          </a>
          <a href="tel:0748950572" class="contact-item">
            <i class="fas fa-phone"></i>
            <span>Call</span>
          </a>
        </div>
      </div>
    </aside>
  </div>

  <!-- Notifications -->
  <div id="notifications"></div>

  <!-- Footer -->
  <footer>
    <p>© <span id="year"></span> Smart Manager – By Tech Brian</p>
    <button class="theme-toggle" id="footer-theme-toggle">
      <i class="fas fa-adjust"></i> Toggle Theme
    </button>
  </footer>

  <script>
    // VAPID Keys (Replace with yours!)
    const VAPID_PUBLIC_KEY = 'BA24fohzKN7d9h-uxyStxvvr9vG1uwDUW-N0Vy0Oyh_89So7SnEuz55myuvzHXQm15P5E2Q5O4ZyZd2vON0cfHI'; // e.g., 'BKj0...'

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            console.log('SW registered!');
            initPush(reg);
          })
          .catch(err => console.log('SW failed:', err));
      });
    }

    // === Install Banner Logic ===
    let deferredPrompt;
    const installBanner = document.getElementById('install-banner');
    const installBtn = document.getElementById('install-btn');
    const installClose = document.getElementById('install-close');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (!localStorage.getItem('install-dismissed')) {
        setTimeout(() => installBanner.classList.add('show'), 5000);
      }
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          localStorage.setItem('install-dismissed', 'true');
          installBanner.classList.remove('show');
        }
        deferredPrompt = null;
      }
    });

    installClose.addEventListener('click', () => {
      localStorage.setItem('install-dismissed', 'true');
      installBanner.classList.remove('show');
    });

    // iOS Fallback (No beforeinstallprompt)
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
      setTimeout(() => {
        if (!localStorage.getItem('install-dismissed')) {
          installBanner.innerHTML = `
            <p><i class="fas fa-info-circle"></i> Add to Home Screen: Tap Share &gt; Add to Home Screen</p>
            <div class="install-actions">
              <button class="install-close" onclick="this.parentElement.parentElement.classList.remove('show'); localStorage.setItem('install-dismissed', 'true');">Got It</button>
            </div>
          `;
          installBanner.classList.add('show');
        }
      }, 5000);
    }

    // === Push Notifications ===
    let isPushEnabled = false;
    const pushToggle = document.getElementById('push-toggle');
    const testPushBtn = document.getElementById('test-push');

    async function initPush(reg) {
      if ('Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window) {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          const subscription = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
          });
          // Send subscription to your server (e.g., /subscribe endpoint)
          await fetch('/subscribe', { method: 'POST', body: JSON.stringify(subscription), headers: { 'Content-Type': 'application/json' } });
          isPushEnabled = true;
          pushToggle.classList.add('enabled');
          testPushBtn.style.display = 'block';
        }
      }
    }

    pushToggle.addEventListener('click', () => {
      if (!isPushEnabled) initPush(navigator.serviceWorker.controller || navigator.serviceWorker.ready);
    });

    testPushBtn.addEventListener('click', () => {
      // Simulate server push (in real: POST to /send-push with payload)
      navigator.serviceWorker.ready.then(reg => {
        reg.showNotification('Test Push!', { body: 'Smart Manager says hi!', icon: 'icon-192.png' });
      });
    });

    // Helper: Convert VAPID key
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    // === Existing Code (Theme, Tasks, etc.) ===
    const splash = document.getElementById('splash');
    const themeToggle = document.getElementById('theme-toggle');
    const footerThemeToggle = document.getElementById('footer-theme-toggle');
    const currentTimeEl = document.getElementById('current-time');
    const taskName = document.getElementById('task-name');
    const taskCategory = document.getElementById('task-category');
    const taskDue = document.getElementById('task-due');
    const addTaskBtn = document.getElementById('add-task');
    const taskList = document.getElementById('task-list');
    const historyList = document.getElementById('history-list');
    const notifications = document.getElementById('notifications');
    const exportBtn = document.getElementById('export-csv');
    const yearSpan = document.getElementById('year');

    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    let history = JSON.parse(localStorage.getItem('history')) || [];
    let countdownIntervals = {};

    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      updateClock();
      setInterval(updateClock, 1000);
      renderTasks();
      renderHistory();
      yearSpan.textContent = new Date().getFullYear();
      setTimeout(() => splash.style.display = 'none', 3000);

      // Check for installed app
      window.addEventListener('appinstalled', () => localStorage.setItem('install-dismissed', 'true'));
    });

    // Theme functions (unchanged)
    function initTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeIcon(next);
      showToast(`Switched to ${next} mode`, 'success');
    }
    function updateThemeIcon(mode) {
      const icon = mode === 'dark' ? 'fa-sun' : 'fa-moon';
      [themeToggle, footerThemeToggle].forEach(btn => {
        btn.querySelector('i').className = `fas ${icon}`;
      });
    }
    themeToggle.addEventListener('click', toggleTheme);
    footerThemeToggle.addEventListener('click', toggleTheme);

    // Clock
    function updateClock() {
      const now = new Date();
      currentTimeEl.textContent = now.toLocaleString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    // Tasks (unchanged, but add push on overdue)
    addTaskBtn.addEventListener('click', addTask);
    taskName.addEventListener('keypress', e => e.key === 'Enter' && addTask());
    function addTask() {
      const name = taskName.value.trim();
      const category = taskCategory.value;
      const due = taskDue.value;
      if (!name || !due) { showToast('Fill task name and due date!', 'error'); return; }
      const id = Date.now().toString();
      const task = { id, name, category, due, status: 'pending', created: new Date().toISOString() };
      tasks.push(task);
      saveTasks();
      renderTasks();
      startCountdown(id, due);
      showToast(`"${name}" added!`, 'success');
      taskName.value = ''; taskDue.value = '';
    }
    function renderTasks() {
      taskList.innerHTML = '';
      tasks.forEach(task => {
        const li = document.createElement('li');
        li.className = `task-item ${task.status}`;
        li.dataset.id = task.id;
        const dueDate = new Date(task.due).toLocaleString();
        li.innerHTML = `
          <div class="task-info">
            <span class="category-badge">${task.category}</span>
            <strong>${task.name}</strong>
            <small>Due: ${dueDate}</small>
            <div class="task-countdown" id="countdown-${task.id}"></div>
          </div>
          <div class="task-actions">
            <button onclick="toggleComplete('${task.id}')"><i class="fas ${task.status === 'completed' ? 'fa-undo' : 'fa-check'}"></i></button>
            <button onclick="deleteTask('${task.id}')"><i class="fas fa-trash"></i></button>
          </div>
        `;
        taskList.appendChild(li);
        if (task.status === 'pending') startCountdown(task.id, task.due);
      });
    }
    window.toggleComplete = function(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      if (task.status === 'pending') {
        task.status = 'completed';
        task.completedAt = new Date().toISOString();
        history.unshift({ ...task, action: 'completed', timestamp: task.completedAt });
        stopCountdown(id);
        showToast(`"${task.name}" completed!`, 'success');
      } else {
        task.status = 'pending';
        delete task.completedAt;
        history.unshift({ id: Date.now() + '-reopen', name: task.name, action: 'reopened', timestamp: new Date().toISOString() });
        startCountdown(id, task.due);
        showToast(`"${task.name}" reopened.`, 'warning');
      }
      saveTasks();
      saveHistory();
      renderTasks();
      renderHistory();
    };
    window.deleteTask = function(id) {
      if (!confirm('Delete this task permanently?')) return;
      tasks = tasks.filter(t => t.id !== id);
      stopCountdown(id);
      saveTasks();
      renderTasks();
      showToast('Task deleted.', 'error');
    };
    function startCountdown(id, dueDate) {
      stopCountdown(id);
      const update = () => {
        const el = document.getElementById(`countdown-${id}`);
        if (!el) return stopCountdown(id);
        const now = new Date();
        const due = new Date(dueDate);
        const diff = due - now;
        if (diff <= 0) {
          el.textContent = 'OVERDUE!';
          el.parentElement.parentElement.classList.add('overdue');
          showToast(`Task overdue: "${tasks.find(t=>t.id===id)?.name}"`, 'error');
          // Send push for overdue
          if (isPushEnabled) {
            navigator.serviceWorker.ready.then(reg => {
              reg.pushManager.getSubscription().then(sub => {
                if (sub) fetch('/send-push', { method: 'POST', body: JSON.stringify({ title: 'Overdue Task!', body: task.name, subscription: sub }), headers: { 'Content-Type': 'application/json' } });
              });
            });
          }
          stopCountdown(id);
          return;
        }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        el.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      };
      update();
      countdownIntervals[id] = setInterval(update, 1000);
    }
    function stopCountdown(id) {
      if (countdownIntervals[id]) {
        clearInterval(countdownIntervals[id]);
        delete countdownIntervals[id];
      }
    }

    // History & Export (unchanged)
    function renderHistory() {
      historyList.innerHTML = '';
      history.slice(0, 20).forEach(entry => {
        const li = document.createElement('li');
        li.className = 'history-item';
        const time = new Date(entry.timestamp).toLocaleString();
        li.innerHTML = `<span><strong>${entry.name}</strong> (${entry.category || '—'})</span><span>${entry.action} • ${time}</span>`;
        historyList.appendChild(li);
      });
    }
    function saveHistory() { localStorage.setItem('history', JSON.stringify(history)); }
    exportBtn.addEventListener('click', () => {
      if (history.length === 0) return showToast('No history to export!', 'error');
      let csv = 'Task,Category,Action,Due,Completed,Timestamp\n';
      history.forEach(h => {
        csv += `"${h.name}","${h.category || ''}","${h.action}","${h.due || ''}","${h.completedAt || ''}","${h.timestamp}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `smart-manager-history-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Exported to CSV!', 'success');
    });

    // Toast
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${message}</span><span class="close" onclick="this.parentElement.remove()">×</span>`;
      notifications.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // Save Tasks
    function saveTasks() { localStorage.setItem('tasks', JSON.stringify(tasks)); }
  </script>
</body>
  </html>
